# RT-Thread 设备和驱动

# 一、RT-Thread IO设备模型框架

RT-Thread 提供了一套简单的 I/O 设备模型框架，如下图所示，它位于硬件和应用程序之间，共分成三层，从上到下分别是 I/O 设备管理层、设备驱动框架层、设备驱动层。

![I/O 设备模型框架](https://www.rt-thread.org/document/site/rt-thread-version/rt-thread-standard/programming-manual/device/figures/io-dev.png)

![image-20240728225818581](https://cdn.jsdelivr.net/gh/CYFS3/Typroa/202407282330796.png)

详细介绍请查看：[官方手册](https://www.rt-thread.org/document/site/#/rt-thread-version/rt-thread-standard/programming-manual/device/device)

# 二、框架是如何对接的

​    ![简单 I/O 设备使用序列图](https://www.rt-thread.org/document/site/rt-thread-version/rt-thread-standard/programming-manual/device/figures/io-call.png)

我们可以看上图，一开始的时候设备驱动会创建设备，并向IO设备管理器进行注册设备。

这一过程是在哪里完成的呢？

可以查看我的这一篇文章：[RT-Thread驱动流程](https://club.rt-thread.org/ask/article/f8f991aaf9f86cce.html)

## 1.Pin

以Pin设备为例子

![image-20240728231000372](https://cdn.jsdelivr.net/gh/CYFS3/Typroa/202407282330797.png)

可以看到他在板极初始化的时候就被自动注册到io设备上。

![image-20240728231103638](https://cdn.jsdelivr.net/gh/CYFS3/Typroa/202407282330798.png)

`_stm32_pin_ops`是stm32控制io的一些操作。

![image-20240728231151890](https://cdn.jsdelivr.net/gh/CYFS3/Typroa/202407282330799.png)

![image-20240728231140225](https://cdn.jsdelivr.net/gh/CYFS3/Typroa/202407282330800.png)

这些函数都有bsp工程师，帮我们想对应的封装好了。

![image-20240728231306622](https://cdn.jsdelivr.net/gh/CYFS3/Typroa/202407282330801.png)

此时我们去调用`rt_pin_write`

![image-20240728231355457](https://cdn.jsdelivr.net/gh/CYFS3/Typroa/202407282330802.png)

就会调用ops中的写函数，实际上就是`_stm32_pin_ops`的写函数。

![image-20240728231518405](https://cdn.jsdelivr.net/gh/CYFS3/Typroa/202407282330803.png)

![image-20240728231536629](https://cdn.jsdelivr.net/gh/CYFS3/Typroa/202407282330804.png)

## 2.iic

我们使用menuconfig使能iic总线

可以看到rtconfig.h

![image-20240728232406341](https://cdn.jsdelivr.net/gh/CYFS3/Typroa/202407282330806.png)

![image-20240728232419539](https://cdn.jsdelivr.net/gh/CYFS3/Typroa/202407282330807.png)

![image-20240728232510743](https://cdn.jsdelivr.net/gh/CYFS3/Typroa/202407282330808.png)

`rt_i2c_bit_ops`就是把ii2相同的特性提前出来，而不同的特性data来调用

![image-20240728232741136](https://cdn.jsdelivr.net/gh/CYFS3/Typroa/202407282330809.png)

![image-20240728232806811](https://cdn.jsdelivr.net/gh/CYFS3/Typroa/202407282330810.png)

![image-20240728232839882](https://cdn.jsdelivr.net/gh/CYFS3/Typroa/202407282330811.png)

可以看到最后的设备层操作函数也是调用设备驱动层的

ps：用文章的形式不好讲清楚，推荐大佬的b站视频：

[Hello!RT-Thread](https://www.bilibili.com/video/BV1SU4y197j7?vd_source=8c1bf9924f2718d7b70c1876a083a32e)
